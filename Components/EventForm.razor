@inject IDataService DataService

<div class="card">
    <div class="card-header-collapsible" @onclick="ToggleExpand">
        <h3>@(IsEdit ? "✏️ 編輯行程" : "✨ 新增行程")</h3>
        <span class="collapse-icon">@(isExpanded ? "▼" : "▶")</span>
    </div>

    @if (isExpanded)
    {
    <div class="form-row">
        <div class="form-group">
            <label>日期</label>
            <input type="date" class="form-control" @bind="formDate" />
        </div>
        <div class="form-group">
            <label>成員</label>
            <select class="form-control" @bind="formMember">
                @foreach (var member in Event.Members)
                {
                    <option value="@member">@member</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>類型</label>
            <select class="form-control" @bind="formType">
                @foreach (var type in Event.EventTypes)
                {
                    <option value="@type">@type</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>每週重複</label>
            <select class="form-control" @bind="formRecurring">
                <option value="">否</option>
                <option value="是">是</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label>內容</label>
        <input type="text" class="form-control" @bind="formContent" placeholder="輸入行程內容" />
    </div>
    <div class="card-actions">
        <button class="btn btn-primary" @onclick="Submit" disabled="@isLoading">
            @(IsEdit ? "更新" : "新增")
        </button>
        @if (IsEdit)
        {
            <button class="btn" @onclick="Cancel">取消</button>
        }
    </div>
    }
</div>

<style>
    .card-header-collapsible {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 0.5rem 0;
    }
    .card-header-collapsible:hover {
        opacity: 0.8;
    }
    .card-header-collapsible h3 {
        margin: 0;
    }
    .collapse-icon {
        font-size: 0.9rem;
        color: #666;
    }
</style>

@code {
    [Parameter] public Event? EditingEvent { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private DateTime formDate = DateTime.Today;
    private string formMember = "哥哥";
    private string formType = "日常行程";
    private string formContent = "";
    private string formRecurring = "";
    private bool isLoading = false;
    private bool isExpanded = false;

    private bool IsEdit => EditingEvent != null;

    private void ToggleExpand() => isExpanded = !isExpanded;

    protected override void OnParametersSet()
    {
        if (EditingEvent != null)
        {
            formDate = EditingEvent.Date;
            formMember = EditingEvent.Member;
            formType = EditingEvent.Type;
            formContent = EditingEvent.Content;
            formRecurring = EditingEvent.Recurring;
            isExpanded = true; // 編輯時自動展開
        }
        else
        {
            ResetForm();
        }
    }

    private void ResetForm()
    {
        formDate = DateTime.Today;
        formMember = "哥哥";
        formType = "日常行程";
        formContent = "";
        formRecurring = "";
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(formContent))
        {
            return;
        }

        isLoading = true;
        try
        {
            var evt = new Event
            {
                RowIndex = EditingEvent?.RowIndex ?? 0,
                Date = formDate,
                Member = formMember,
                Type = formType,
                Content = formContent,
                Recurring = formRecurring
            };

            if (IsEdit)
            {
                await DataService.UpdateEventAsync(evt);
            }
            else
            {
                await DataService.AddEventAsync(evt);
            }

            ResetForm();
            await OnSaved.InvokeAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Cancel()
    {
        ResetForm();
        await OnCancel.InvokeAsync();
    }
}
