@inject IDataService DataService

<div class="goals-section">
    <h2>ğŸ¯ ç›®æ¨™ç‰†</h2>

    @if (goals.Any())
    {
        <div class="goals-grid">
            @foreach (var goal in goals.OrderBy(g => g.Deadline))
            {
                <div class="goal-card @goal.GetCardClass()">
                    <div class="goal-header">
                        <div>
                            <span class="goal-title">@goal.GetMemberEmoji() @goal.GoalName</span>
                            <div class="goal-deadline">æˆªæ­¢ï¼š@goal.Deadline.ToString("yyyy/MM/dd")</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success" @onclick="() => CompleteGoal(goal)">âœ…</button>
                            <button class="btn btn-sm btn-warning" @onclick="() => EditGoal(goal)">âœï¸</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteGoal(goal)">ğŸ—‘ï¸</button>
                        </div>
                    </div>

                    @foreach (var sub in goal.GetSubItems())
                    {
                        <div class="sub-item">
                            <div class="sub-item-header">
                                <span>@sub.Name</span>
                                <span>@sub.Percent%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: @sub.Percent%"></div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <p>ç›®å‰æ²’æœ‰è¨­å®šç›®æ¨™å–”ï¼</p>
    }

    <div class="card" style="margin-top: 1rem;">
        <h3>@(editingGoal != null ? "âœï¸ ç·¨è¼¯ç›®æ¨™" : "â• æ–°å¢ç›®æ¨™")</h3>
        <div class="form-row">
            <div class="form-group">
                <label>æˆå“¡</label>
                <select class="form-control" @bind="formMember">
                    @foreach (var m in Event.Members)
                    {
                        <option value="@m">@m</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>ç›®æ¨™åç¨±</label>
                <input type="text" class="form-control" @bind="formGoalName" />
            </div>
            <div class="form-group">
                <label>æˆªæ­¢æ—¥æœŸ</label>
                <input type="date" class="form-control" @bind="formDeadline" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å­é …ç›® 1</label>
                <input type="text" class="form-control" @bind="formSub1" />
            </div>
            <div class="form-group">
                <label>é€²åº¦ %</label>
                <input type="number" class="form-control" @bind="formSub1Pct" min="0" max="100" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å­é …ç›® 2</label>
                <input type="text" class="form-control" @bind="formSub2" />
            </div>
            <div class="form-group">
                <label>é€²åº¦ %</label>
                <input type="number" class="form-control" @bind="formSub2Pct" min="0" max="100" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å­é …ç›® 3</label>
                <input type="text" class="form-control" @bind="formSub3" />
            </div>
            <div class="form-group">
                <label>é€²åº¦ %</label>
                <input type="number" class="form-control" @bind="formSub3Pct" min="0" max="100" />
            </div>
        </div>
        <div class="card-actions">
            <button class="btn btn-primary" @onclick="SaveGoal">@(editingGoal != null ? "æ›´æ–°" : "æ–°å¢")</button>
            @if (editingGoal != null)
            {
                <button class="btn" @onclick="CancelEdit">å–æ¶ˆ</button>
            }
        </div>
    </div>
</div>

@code {
    private List<Goal> goals = new();
    private Goal? editingGoal = null;

    private string formMember = "å“¥å“¥";
    private string formGoalName = "";
    private DateTime formDeadline = DateTime.Today.AddMonths(1);
    private string formSub1 = "";
    private int formSub1Pct = 0;
    private string formSub2 = "";
    private int formSub2Pct = 0;
    private string formSub3 = "";
    private int formSub3Pct = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadGoals();
    }

    private async Task LoadGoals()
    {
        goals = await DataService.GetGoalsAsync();
    }

    private void EditGoal(Goal goal)
    {
        editingGoal = goal;
        formMember = goal.Member;
        formGoalName = goal.GoalName;
        formDeadline = goal.Deadline;
        formSub1 = goal.Sub1;
        formSub1Pct = goal.Sub1Pct;
        formSub2 = goal.Sub2;
        formSub2Pct = goal.Sub2Pct;
        formSub3 = goal.Sub3;
        formSub3Pct = goal.Sub3Pct;
    }

    private void CancelEdit()
    {
        editingGoal = null;
        ResetForm();
    }

    private void ResetForm()
    {
        formMember = "å“¥å“¥";
        formGoalName = "";
        formDeadline = DateTime.Today.AddMonths(1);
        formSub1 = "";
        formSub1Pct = 0;
        formSub2 = "";
        formSub2Pct = 0;
        formSub3 = "";
        formSub3Pct = 0;
    }

    private async Task SaveGoal()
    {
        if (string.IsNullOrWhiteSpace(formGoalName)) return;

        var goal = new Goal
        {
            RowIndex = editingGoal?.RowIndex ?? 0,
            Member = formMember,
            GoalName = formGoalName,
            Deadline = formDeadline,
            Sub1 = formSub1,
            Sub1Pct = formSub1Pct,
            Sub2 = formSub2,
            Sub2Pct = formSub2Pct,
            Sub3 = formSub3,
            Sub3Pct = formSub3Pct
        };

        if (editingGoal != null)
        {
            await DataService.UpdateGoalAsync(goal);
        }
        else
        {
            await DataService.AddGoalAsync(goal);
        }

        editingGoal = null;
        ResetForm();
        await LoadGoals();
    }

    private async Task DeleteGoal(Goal goal)
    {
        await DataService.DeleteGoalAsync(goal.RowIndex);
        await LoadGoals();
    }

    private async Task CompleteGoal(Goal goal)
    {
        await DataService.CompleteGoalAsync(goal);
        await LoadGoals();
    }
}
