@page "/"
@inject IDataService DataService

<div class="main-content">
    <!-- ç›®æ¨™ç‰† -->
    <GoalsWall />

    <!-- æ–°å¢/ç·¨è¼¯è¡Œç¨‹è¡¨å–® -->
    <EventForm EditingEvent="@editingEvent" OnSaved="OnEventSaved" OnCancel="CancelEdit" />

    <!-- é ç±¤ -->
    <div class="tabs">
        <button class="tab @(activeTab == "cards" ? "active" : "")" @onclick="SetTabCards">
            ğŸ“‹ è¡Œç¨‹å¡ç‰‡
        </button>
        <button class="tab @(activeTab == "week" ? "active" : "")" @onclick="SetTabWeek">
            ğŸ“† æœ¬é€±è¡Œç¨‹
        </button>
        <button class="tab @(activeTab == "history" ? "active" : "")" @onclick="SetTabHistory">
            ğŸ“œ æ­·å²ç´€éŒ„
        </button>
    </div>

    <!-- è¡Œç¨‹å¡ç‰‡è¦–åœ– -->
    @if (activeTab == "cards")
    {
        <h2>ğŸ“… è¿‘æœŸè¡Œç¨‹ç¸½è¦½</h2>
        @if (isLoading)
        {
            <p>è¼‰å…¥ä¸­...</p>
        }
        else if (!futureEvents.Any())
        {
            <p>ç›®å‰æ²’æœ‰æœªä¾†çš„è¡Œç¨‹å–”ï¼</p>
        }
        else
        {
            <div class="events-grid">
                @foreach (var evt in futureEvents)
                {
                    <EventCard Event="@evt"
                               OnEdit="() => StartEdit(evt)"
                               OnRefresh="LoadEvents" />
                }
            </div>
        }
    }

    <!-- æœ¬é€±è¡Œç¨‹è¦–åœ– -->
    @if (activeTab == "week")
    {
        <WeeklyView Events="@events" />
    }

    <!-- æ­·å²ç´€éŒ„è¦–åœ– -->
    @if (activeTab == "history")
    {
        <HistoryView />
    }

    <!-- ç©åˆ†æ’è¡Œæ¦œ -->
    <PointsLeaderboard />
</div>

@code {
    private List<Event> events = new();
    private List<Event> futureEvents = new();
    private Event? editingEvent = null;
    private string activeTab = "cards";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadEvents();
    }

    private async Task LoadEvents()
    {
        isLoading = true;
        try
        {
            events = await DataService.GetEventsAsync();
            futureEvents = events
                .Where(e => e.Date.Date >= DateTime.Today)
                .OrderBy(e => e.Date)
                .ToList();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartEdit(Event evt)
    {
        editingEvent = evt;
    }

    private void CancelEdit()
    {
        editingEvent = null;
    }

    private void SetTabCards() => activeTab = "cards";
    private void SetTabWeek() => activeTab = "week";
    private void SetTabHistory() => activeTab = "history";

    private async Task OnEventSaved()
    {
        editingEvent = null;
        await LoadEvents();
    }
}

<style>
    .main-content {
        padding-bottom: 2rem;
    }

    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }

    @@media (max-width: 768px) {
        .events-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
